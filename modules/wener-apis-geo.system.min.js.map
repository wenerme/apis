{"version":3,"file":"wener-apis-geo.system.min.js","sources":["../../src/modules/geo/components/LocationMeLite.tsx"],"sourcesContent":["import React, { useRef, useState } from 'react';\nimport { useAsyncEffect } from '@wener/ui';\nimport { Alert, Descriptions } from 'antd';\nimport { useConstant } from '@wener/ui';\n// import { Console as ConsoleFeed, Hook, Unhook } from 'console-feed';\n// import type { HookedConsole } from 'console-feed/lib/definitions/Console';\n\nfunction usePosition(options: { console?; onError?; onWarn?; onInfo?; onPosition?: (pos: Position) => void }) {\n  const idRef = useRef<any>();\n  useAsyncEffect(async () => {\n    const {\n      console = window.console,\n      onPosition = () => null,\n      onError = console.error,\n      onInfo = console.info,\n      onWarn = console.warn,\n    } = options;\n\n    if (!('geolocation' in navigator)) {\n      onError('无 geolocation 支持');\n      return;\n    }\n\n    await new Promise((resolve, reject) => {\n      if ('permissions' in navigator) {\n        onInfo('有 permissions 支持');\n\n        navigator.permissions.query({ name: 'geolocation' }).then((result) => {\n          if (result.state === 'granted') {\n            onInfo('已授权');\n            resolve(true);\n          } else if (result.state === 'prompt') {\n            onWarn('待请求授权');\n            resolve(false);\n          } else {\n            onError('未授权 ' + JSON.stringify(result));\n            resolve(false);\n          }\n        });\n      } else {\n        onError('无 permissions 支持');\n        resolve(false);\n      }\n    });\n\n    onInfo('开始获取定位... 超时=15秒');\n\n    let watchId;\n    try {\n      idRef.current = watchId = navigator.geolocation.getCurrentPosition(\n        (position) => {\n          onInfo('获取定位成功', position);\n\n          onPosition(position);\n\n          onInfo('开始进行持续定位');\n          navigator.geolocation.watchPosition(\n            (position) => {\n              onInfo('更新定位', position);\n              onPosition(position);\n            },\n            (error) => {\n              onWarn('持续定位失败 code:' + error.code + '  message:' + error.message, error);\n            },\n            {\n              enableHighAccuracy: true,\n              timeout: 15000,\n              maximumAge: 0,\n            },\n          );\n        },\n        (error) => {\n          onError('获取失败 code:' + error.code + '  message:' + error.message, error);\n        },\n        {\n          enableHighAccuracy: true,\n          timeout: 15000,\n          maximumAge: 0,\n        },\n      );\n    } catch (e) {\n      onError('操作失败', e);\n    }\n    return () => navigator.geolocation.clearWatch(watchId);\n  }, []);\n  return () => {\n    if (idRef.current) {\n      navigator.geolocation.clearWatch(idRef.current);\n      idRef.current = null;\n    }\n  };\n}\n\nfunction createFakeConsole({ onRecord }) {\n  const levels = ['log', 'debug', 'info', 'warn', 'error', 'table', 'clear', 'time', 'timeEnd', 'count', 'assert'];\n  const c = {};\n  levels.forEach((v) => (c[v] = (...message) => onRecord({ level: v, message })));\n  return c;\n}\n\nexport const LocationMeLite: React.FC = () => {\n  const [logs, setLogs] = useState<any[]>([]);\n  const [position, setPosition] = useState<any>(null);\n  const con = useConstant(() =>\n    createFakeConsole({\n      onRecord: (r) => {\n        console[r.level](...r.message);\n        setLogs((v) => [...v, r]);\n      },\n    }),\n  );\n  usePosition({ onPosition: setPosition, console: con });\n\n  return (\n    <div>\n      <h4>定位信息</h4>\n      {position && <LocationDescription position={position} />}\n      {!position && <div>获取中。。。</div>}\n\n      <div>\n        <h4>日志</h4>\n        <div style={{ padding: 16 /*console-feed color backgroundColor: '#242424', */ }}>\n          {logs.map((v, i) => (\n            <Alert\n              style={{ border: 'none' }}\n              showIcon\n              key={i}\n              type={{ info: 'info', warn: 'warning', error: 'error' }[v.level] || 'info'}\n              message={String(v.message)}\n            />\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport const LocationDescription: React.FC<{ position?: Position }> = ({ position }) => {\n  if (!position) {\n    return <div>获取中...</div>;\n  }\n  const { latitude, longitude, accuracy, altitude, altitudeAccuracy, heading, speed } = position.coords;\n  return (\n    <div>\n      <Descriptions>\n        <Descriptions.Item label=\"坐标 (lat,lon)\">{`${latitude},${longitude}`}</Descriptions.Item>\n        <Descriptions.Item label=\"坐标精度\">{accuracy} 米</Descriptions.Item>\n        <Descriptions.Item label=\"高度\">{altitude}</Descriptions.Item>\n        <Descriptions.Item label=\"高度精度\">{altitudeAccuracy} 米</Descriptions.Item>\n        <Descriptions.Item label=\"朝向\">{heading}</Descriptions.Item>\n        <Descriptions.Item label=\"速度\">{speed}</Descriptions.Item>\n      </Descriptions>\n    </div>\n  );\n};\n"],"names":["logs","setLogs","useState","position","setPosition","options","idRef","useRef","useAsyncEffect","async","console","window","onPosition","onError","error","onInfo","info","onWarn","warn","navigator","watchId","Promise","resolve","reject","permissions","query","name","then","result","state","JSON","stringify","current","geolocation","getCurrentPosition","watchPosition","code","message","enableHighAccuracy","timeout","maximumAge","e","clearWatch","usePosition","useConstant","onRecord","c","forEach","v","level","createFakeConsole","r","React","LocationDescription","style","padding","map","i","Alert","border","showIcon","key","type","String","latitude","longitude","accuracy","altitude","altitudeAccuracy","heading","speed","coords","Descriptions","Item","label"],"mappings":"yRAoGwC,WAC/BA,EAAMC,GAAWC,EAAgB,KACjCC,EAAUC,GAAeF,EAAc,aA/FhD,SAAqBG,SACbC,EAAQC,IACdC,EAAeC,gBACPC,QACJA,EAAUC,OAAOD,QADbE,WAEJA,EAAa,KAAM,MAFfC,QAGJA,EAAUH,EAAQI,MAHdC,OAIJA,EAASL,EAAQM,KAJbC,OAKJA,EAASP,EAAQQ,MACfb,OAEE,gBAAiBc,uBACrBN,EAAQ,wBA4BNO,QAxBE,IAAIC,QAAQ,CAACC,EAASC,KACtB,gBAAiBJ,WACnBJ,EAAO,oBAEPI,UAAUK,YAAYC,MAAM,CAAEC,KAAM,gBAAiBC,KAAMC,IACpC,YAAjBA,EAAOC,OACTd,EAAO,OACPO,GAAQ,IACkB,WAAjBM,EAAOC,OAChBZ,EAAO,SACPK,GAAQ,KAERT,EAAQ,OAASiB,KAAKC,UAAUH,IAChCN,GAAQ,QAIZT,EAAQ,oBACRS,GAAQ,MAIZP,EAAO,wBAILT,EAAM0B,QAAUZ,EAAUD,UAAUc,YAAYC,mBAC7C/B,IACCY,EAAO,SAAUZ,GAEjBS,EAAWT,GAEXY,EAAO,YACPI,UAAUc,YAAYE,cACnBhC,IACCY,EAAO,OAAQZ,GACfS,EAAWT,IAEZW,IACCG,EAAO,eAAiBH,EAAMsB,KAAO,aAAetB,EAAMuB,QAASvB,IAErE,CACEwB,oBAAoB,EACpBC,QAAS,KACTC,WAAY,KAIjB1B,IACCD,EAAQ,aAAeC,EAAMsB,KAAO,aAAetB,EAAMuB,QAASvB,IAEpE,CACEwB,oBAAoB,EACpBC,QAAS,KACTC,WAAY,IAGhB,MAAOC,GACP5B,EAAQ,OAAQ4B,SAEX,IAAMtB,UAAUc,YAAYS,WAAWtB,IAC7C,IA2BHuB,CAAY,CAAE/B,WAAYR,EAAaM,QAR3BkC,EAAY,IAV1B,UAA2BC,SAAEA,UAErBC,EAAI,SADK,CAAC,MAAO,QAAS,OAAQ,OAAQ,QAAS,QAAS,QAAS,OAAQ,UAAW,QAAS,UAEhGC,QAASC,GAAOF,EAAEE,GAAK,IAAIX,IAAYQ,EAAS,CAAEI,MAAOD,EAAGX,QAAAA,KAC5DS,EAOLI,CAAkB,CAChBL,SAAWM,IACTzC,QAAQyC,EAAEF,UAAUE,EAAEd,SACtBpC,EAAS+C,GAAM,IAAIA,EAAGG,UAO1BC,2BACEA,kCACCjD,GAAYiD,gBAACC,GAAoBlD,SAAUA,KAC1CA,GAAYiD,qCAEdA,2BACEA,gCACAA,uBAAKE,MAAO,CAAEC,QAAS,KACpBvD,EAAKwD,IAAI,CAACR,EAAGS,IACZL,gBAACM,GACCJ,MAAO,CAAEK,OAAQ,QACjBC,YACAC,IAAKJ,EACLK,KAAM,CAAE9C,KAAM,OAAQE,KAAM,UAAWJ,MAAO,SAAUkC,EAAEC,QAAU,OACpEZ,QAAS0B,OAAOf,EAAEX,uBASnBgB,0BAAyD,EAAGlD,SAAAA,UAClEA,SACIiD,2CAEHY,SAAEA,EAAFC,UAAYA,EAAZC,SAAuBA,EAAvBC,SAAiCA,EAAjCC,iBAA2CA,EAA3CC,QAA6DA,EAA7DC,MAAsEA,GAAUnE,EAASoE,cAE7FnB,2BACEA,gBAACoB,OACCpB,gBAACoB,EAAaC,MAAKC,MAAM,gBAAiB,GAAEV,KAAYC,KACxDb,gBAACoB,EAAaC,MAAKC,MAAM,QAAQR,QACjCd,gBAACoB,EAAaC,MAAKC,MAAM,MAAMP,GAC/Bf,gBAACoB,EAAaC,MAAKC,MAAM,QAAQN,QACjChB,gBAACoB,EAAaC,MAAKC,MAAM,MAAML,GAC/BjB,gBAACoB,EAAaC,MAAKC,MAAM,MAAMJ"}