{"version":3,"file":"wener-apis-geo.system.js","sources":["../../src/modules/geo/components/LocationMeLite.tsx"],"sourcesContent":["import React, { useRef, useState } from 'react';\nimport { useAsyncEffect } from '@wener/ui';\nimport { Alert, Descriptions } from 'antd';\nimport { useConstant } from '@wener/ui';\n// import { Console as ConsoleFeed, Hook, Unhook } from 'console-feed';\n// import type { HookedConsole } from 'console-feed/lib/definitions/Console';\n\nfunction usePosition(options: { console?; onError?; onWarn?; onInfo?; onPosition?: (pos: Position) => void }) {\n  const idRef = useRef<any>();\n  useAsyncEffect(async () => {\n    const {\n      console = window.console,\n      onPosition = () => null,\n      onError = console.error,\n      onInfo = console.info,\n      onWarn = console.warn,\n    } = options;\n\n    if (!('geolocation' in navigator)) {\n      onError('无 geolocation 支持');\n      return;\n    }\n\n    await new Promise((resolve, reject) => {\n      if ('permissions' in navigator) {\n        onInfo('有 permissions 支持');\n\n        navigator.permissions.query({ name: 'geolocation' }).then((result) => {\n          if (result.state === 'granted') {\n            onInfo('已授权');\n            resolve(true);\n          } else if (result.state === 'prompt') {\n            onWarn('待请求授权');\n            resolve(false);\n          } else {\n            onError('未授权 ' + JSON.stringify(result));\n            resolve(false);\n          }\n        });\n      } else {\n        onError('无 permissions 支持');\n        resolve(false);\n      }\n    });\n\n    onInfo('开始获取定位... 超时=15秒');\n\n    let watchId;\n    try {\n      idRef.current = watchId = navigator.geolocation.getCurrentPosition(\n        (position) => {\n          onInfo('获取定位成功', position);\n\n          onPosition(position);\n\n          onInfo('开始进行持续定位');\n          navigator.geolocation.watchPosition(\n            (position) => {\n              onInfo('更新定位', position);\n              onPosition(position);\n            },\n            (error) => {\n              onWarn('持续定位失败 code:' + error.code + '  message:' + error.message, error);\n            },\n            {\n              enableHighAccuracy: true,\n              timeout: 15000,\n              maximumAge: 0,\n            },\n          );\n        },\n        (error) => {\n          onError('获取失败 code:' + error.code + '  message:' + error.message, error);\n        },\n        {\n          enableHighAccuracy: true,\n          timeout: 15000,\n          maximumAge: 0,\n        },\n      );\n    } catch (e) {\n      onError('操作失败', e);\n    }\n    return () => navigator.geolocation.clearWatch(watchId);\n  }, []);\n  return () => {\n    if (idRef.current) {\n      navigator.geolocation.clearWatch(idRef.current);\n      idRef.current = null;\n    }\n  };\n}\n\nfunction createFakeConsole({ onRecord }) {\n  const levels = ['log', 'debug', 'info', 'warn', 'error', 'table', 'clear', 'time', 'timeEnd', 'count', 'assert'];\n  const c = {};\n  levels.forEach((v) => (c[v] = (...message) => onRecord({ level: v, message })));\n  return c;\n}\n\nexport const LocationMeLite: React.FC = () => {\n  const [logs, setLogs] = useState<any[]>([]);\n  const [position, setPosition] = useState<any>(null);\n  const con = useConstant(() =>\n    createFakeConsole({\n      onRecord: (r) => {\n        console[r.level](...r.message);\n        setLogs((v) => [...v, r]);\n      },\n    }),\n  );\n  usePosition({ onPosition: setPosition, console: con });\n\n  return (\n    <div>\n      <h4>定位信息</h4>\n      {position && <LocationDescription position={position} />}\n      {!position && <div>获取中。。。</div>}\n\n      <div>\n        <h4>日志</h4>\n        <div style={{ padding: 16 /*console-feed color backgroundColor: '#242424', */ }}>\n          {logs.map((v, i) => (\n            <Alert\n              style={{ border: 'none' }}\n              showIcon\n              key={i}\n              type={{ info: 'info', warn: 'warning', error: 'error' }[v.level] || 'info'}\n              message={String(v.message)}\n            />\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport const LocationDescription: React.FC<{ position?: Position }> = ({ position }) => {\n  if (!position) {\n    return <div>获取中...</div>;\n  }\n  const { latitude, longitude, accuracy, altitude, altitudeAccuracy, heading, speed } = position.coords;\n  return (\n    <div>\n      <Descriptions>\n        <Descriptions.Item label=\"坐标 (lat,lon)\">{`${latitude},${longitude}`}</Descriptions.Item>\n        <Descriptions.Item label=\"坐标精度\">{accuracy} 米</Descriptions.Item>\n        <Descriptions.Item label=\"高度\">{altitude}</Descriptions.Item>\n        <Descriptions.Item label=\"高度精度\">{altitudeAccuracy} 米</Descriptions.Item>\n        <Descriptions.Item label=\"朝向\">{heading}</Descriptions.Item>\n        <Descriptions.Item label=\"速度\">{speed}</Descriptions.Item>\n      </Descriptions>\n    </div>\n  );\n};\n"],"names":["usePosition","options","idRef","useRef","useAsyncEffect","console","window","onPosition","onError","error","onInfo","info","onWarn","warn","navigator","Promise","resolve","reject","permissions","query","name","then","result","state","JSON","stringify","watchId","current","geolocation","getCurrentPosition","position","watchPosition","code","message","enableHighAccuracy","timeout","maximumAge","e","clearWatch","createFakeConsole","onRecord","levels","c","forEach","v","level","LocationMeLite","logs","setLogs","useState","setPosition","con","useConstant","r","padding","map","i","border","String","LocationDescription","latitude","longitude","accuracy","altitude","altitudeAccuracy","heading","speed","coords"],"mappings":"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"}