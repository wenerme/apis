{"version":3,"file":"wener-apis-boot.system.js","sources":["../../src/modules/boot/ModuleService.ts","../../src/modules/boot/BootService.ts","../../src/modules/boot/overrides.ts","../../src/modules/boot/boot.ts","../../src/modules/boot/base.ts"],"sourcesContent":["export interface ModuleResolveOptions {\n  /// @wener/ui/icons\n  name: string;\n  parentName?: string;\n  parentUrl?: string;\n  dev?: boolean;\n}\n\nexport type ModuleResolver = (opts: ModuleResolveOptions) => string;\n\nexport class ModuleService {\n  internals: RegExp[] = [];\n  resolver: ModuleResolver;\n  dev = false;\n  overrides: Record<string, string> = {};\n  readonly imports: Record<string, string> = {};\n  readonly resolved: Record<string, string> = {};\n  readonly dependencies: Record<string, string[]> = {};\n\n  isInternal(id) {\n    const { internals } = this;\n    for (const regex of internals) {\n      if (regex.test(id)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  resolve({ id, parentUrl = undefined, original = undefined }) {\n    let resolved = this.tryResolve(id);\n    if (!resolved) {\n      try {\n        resolved = original(id, parentUrl);\n      } catch (err) {\n        console.error(`fallback to jsdelivr resolve - `, id);\n        resolved = `https://cdn.jsdelivr.net/npm/${id}`;\n      }\n    }\n    if (parentUrl) {\n      const parentName = this.resolveName(parentUrl);\n      if (!parentName) {\n        console.warn('can not get name from parent url', parentUrl);\n      } else {\n        const deps = (this.dependencies[parentName] = this.dependencies[parentName] || []);\n        deps.includes(id) || deps.push(id);\n      }\n    }\n    this.resolved[id] = resolved;\n    return resolved;\n  }\n\n  tryResolve(id: string, parentUrl?): string | undefined {\n    const { overrides, imports } = this;\n    // existing\n    const r = overrides[id] || imports[id];\n    if (r) {\n      return this.normalizeModuleUrl(r);\n    }\n    // internals\n    if (this.resolver && this.isInternal(id)) {\n      return this.resolver({ dev: this.dev, name: id, parentUrl, parentName: this.resolveName(parentUrl) });\n    }\n  }\n\n  /**\n   * url to module name\n   */\n  resolveName(url: string): string | undefined {\n    if (!url) {\n      return;\n    }\n    {\n      const e = Object.entries(this.resolved).find(([_, v]) => v === url);\n      if (e) {\n        return e[0];\n      }\n    }\n\n    const local = location.origin;\n    if (url.startsWith(local)) {\n      // under the modules path\n      const m = url.substr(local.length).match(/modules[/](\\w+)-([^.]+)/);\n      if (m) {\n        return `@${m[1]}/${m[2]}`;\n      }\n    }\n    const jsdelivr = 'https://cdn.jsdelivr.net/npm/';\n    if (url.startsWith(jsdelivr)) {\n      const m = url.substr(local.length).match(/(@[^/]+[/][^/]+)/);\n      if (m) {\n        return m[1];\n      }\n    }\n    let found = Object.entries(this.imports).find(([_, v]) => v === url)?.[0];\n    if (found) {\n      return found;\n    }\n    found = Object.entries(this.resolved).find(([_, v]) => v === url)?.[0];\n    return found;\n  }\n\n  private normalizeModuleUrl(v) {\n    // placeholder\n    // /modules/test.js -> ${baseUrl}/modules/test.js\n    return v;\n  }\n}\n","import { ModuleService } from 'src/modules/boot/ModuleService';\nimport { System } from './types';\n\nexport class BootService {\n  readonly modules = new ModuleService();\n  readonly System: System;\n  readonly baselUrl: string;\n\n  constructor({ System = window['System'], baselUrl = location.origin } = {}) {\n    this.baselUrl = baselUrl;\n    this.System = System;\n  }\n\n  resolvePath(v: string): string {\n    return new URL(v, this.baselUrl).href;\n  }\n}\n","const key = 'ImportOverrides';\n\nexport async function loadImportOverrides(): Promise<Record<string, string>> {\n  try {\n    return JSON.parse(localStorage[key] || '{}');\n  } catch (e) {\n    console.error(`failed to load overrides`, e);\n  }\n  return {};\n}\n\nexport async function persistImportOverrides(overrides) {\n  localStorage[key] = JSON.stringify(overrides);\n}\n","import { BootService } from 'src/modules/boot/BootService';\nimport imports from './imports.json';\nimport { ModuleResolver } from 'src/modules/boot/ModuleService';\nimport { loadImportOverrides } from 'src/modules/boot/overrides';\n\nlet _bootService;\n\nexport function getBootService(): BootService {\n  return _bootService;\n}\n\nexport interface BootstrapOptions {\n  dev?: boolean;\n  internals?: RegExp[];\n  baselUrl?: string;\n  resolver: ModuleResolver;\n}\n\nexport async function boot(opts: BootstrapOptions) {\n  console.info(`Bootstrapping system`);\n\n  const bootService = new BootService(opts);\n  _bootService = bootService;\n\n  const modules = bootService.modules;\n  modules.resolver = opts.resolver;\n  modules.dev = opts.dev;\n  if (opts.internals) {\n    modules.internals.push(...opts.internals);\n  }\n  // preset imports\n  Object.assign(modules.imports, imports);\n  // override works\n  Object.assign(modules.overrides, await loadImportOverrides());\n\n  console.info(`Injecting system resolve`);\n\n  const System = window['System'];\n  const originalResolve = System.constructor.prototype.resolve;\n  System.constructor.prototype.resolve = function (id, parentUrl) {\n    const resolved = modules.resolve({\n      id,\n      parentUrl,\n      original: (...args) => originalResolve.apply(this, args),\n    });\n    console.debug(`resolve ${id} to ${resolved} from ${parentUrl}`);\n    return resolved;\n  };\n}\n","\nexport function getBaseUrl() {\n  // allowed override base url\n  return (localStorage['BASE_URL'] || location.href);\n}\n\nexport function resolvePath(v: string): string {\n  return new URL(v, getBaseUrl()).href;\n}\n"],"names":["ModuleService","internals","resolver","dev","overrides","imports","resolved","dependencies","isInternal","id","regex","test","resolve","parentUrl","undefined","original","tryResolve","err","console","error","parentName","resolveName","warn","deps","includes","push","r","normalizeModuleUrl","name","url","e","Object","entries","find","_","v","local","location","origin","startsWith","m","substr","length","match","jsdelivr","found","BootService","constructor","System","window","baselUrl","modules","resolvePath","URL","href","key","loadImportOverrides","JSON","parse","localStorage","persistImportOverrides","stringify","_bootService","getBootService","boot","opts","info","bootService","assign","originalResolve","prototype","args","apply","debug","getBaseUrl"],"mappings":"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"}