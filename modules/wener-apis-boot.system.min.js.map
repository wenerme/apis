{"version":3,"file":"wener-apis-boot.system.min.js","sources":["../../src/modules/boot/boot.ts","../../src/modules/boot/overrides.ts","../../src/modules/boot/base.ts","../../src/modules/boot/ModuleService.ts","../../src/modules/boot/BootService.ts"],"sourcesContent":["import { BootService } from 'src/modules/boot/BootService';\nimport imports from './imports.json';\nimport { ModuleResolver } from 'src/modules/boot/ModuleService';\nimport { loadImportOverrides } from 'src/modules/boot/overrides';\n\nlet _bootService;\n\nexport function getBootService(): BootService {\n  return _bootService;\n}\n\nexport interface BootstrapOptions {\n  dev?: boolean;\n  internals?: RegExp[];\n  baselUrl?: string;\n  resolver: ModuleResolver;\n}\n\nexport async function boot(opts: BootstrapOptions) {\n  console.info(`Bootstrapping system`);\n\n  const bootService = new BootService(opts);\n  _bootService = bootService;\n\n  const modules = bootService.modules;\n  modules.resolver = opts.resolver;\n  modules.dev = opts.dev;\n  if (opts.internals) {\n    modules.internals.push(...opts.internals);\n  }\n  // preset imports\n  Object.assign(modules.imports, imports);\n  // override works\n  Object.assign(modules.overrides, await loadImportOverrides());\n\n  console.info(`Injecting system resolve`);\n\n  const System = window['System'];\n  const originalResolve = System.constructor.prototype.resolve;\n  System.constructor.prototype.resolve = function (id, parentUrl) {\n    const resolved = modules.resolve({\n      id,\n      parentUrl,\n      original: (...args) => originalResolve.apply(this, args),\n    });\n    console.debug(`resolve ${id} to ${resolved} from ${parentUrl}`);\n    return resolved;\n  };\n}\n","const key = 'ImportOverrides';\n\nexport async function loadImportOverrides(): Promise<Record<string, string>> {\n  try {\n    return JSON.parse(localStorage[key] || '{}');\n  } catch (e) {\n    console.error(`failed to load overrides`, e);\n  }\n  return {};\n}\n\nexport async function persistImportOverrides(overrides) {\n  localStorage[key] = JSON.stringify(overrides);\n}\n","\nexport function getBaseUrl() {\n  // allowed override base url\n  return (localStorage['BASE_URL'] || location.href);\n}\n\nexport function resolvePath(v: string): string {\n  return new URL(v, getBaseUrl()).href;\n}\n","export interface ModuleResolveOptions {\n  /// @wener/ui/icons\n  name: string;\n  parentName?: string;\n  parentUrl?: string;\n  dev?: boolean;\n}\n\nexport type ModuleResolver = (opts: ModuleResolveOptions) => string;\n\nexport class ModuleService {\n  internals: RegExp[] = [];\n  resolver: ModuleResolver;\n  dev = false;\n  overrides: Record<string, string> = {};\n  readonly imports: Record<string, string> = {};\n  readonly resolved: Record<string, string> = {};\n  readonly dependencies: Record<string, string[]> = {};\n\n  isInternal(id) {\n    const { internals } = this;\n    for (const regex of internals) {\n      if (regex.test(id)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  resolve({ id, parentUrl = undefined, original = undefined }) {\n    let resolved = this.tryResolve(id);\n    if (!resolved) {\n      try {\n        resolved = original(id, parentUrl);\n      } catch (err) {\n        console.error(`fallback to jsdelivr resolve - `, id);\n        resolved = `https://cdn.jsdelivr.net/npm/${id}`;\n      }\n    }\n    if (parentUrl) {\n      const parentName = this.resolveName(parentUrl);\n      if (!parentName) {\n        console.warn('can not get name from parent url', parentUrl);\n      } else {\n        const deps = (this.dependencies[parentName] = this.dependencies[parentName] || []);\n        deps.includes(id) || deps.push(id);\n      }\n    }\n    this.resolved[id] = resolved;\n    return resolved;\n  }\n\n  tryResolve(id: string, parentUrl?): string | undefined {\n    const { overrides, imports } = this;\n    // existing\n    const r = overrides[id] || imports[id];\n    if (r) {\n      return this.normalizeModuleUrl(r);\n    }\n    // internals\n    if (this.resolver && this.isInternal(id)) {\n      return this.resolver({ dev: this.dev, name: id, parentUrl, parentName: this.resolveName(parentUrl) });\n    }\n  }\n\n  /**\n   * url to module name\n   */\n  resolveName(url: string): string | undefined {\n    if (!url) {\n      return;\n    }\n    {\n      const e = Object.entries(this.resolved).find(([_, v]) => v === url);\n      if (e) {\n        return e[0];\n      }\n    }\n\n    const local = location.origin;\n    if (url.startsWith(local)) {\n      // under the modules path\n      const m = url.substr(local.length).match(/modules[/](\\w+)-([^.]+)/);\n      if (m) {\n        return `@${m[1]}/${m[2]}`;\n      }\n    }\n    const jsdelivr = 'https://cdn.jsdelivr.net/npm/';\n    if (url.startsWith(jsdelivr)) {\n      const m = url.substr(local.length).match(/(@[^/]+[/][^/]+)/);\n      if (m) {\n        return m[1];\n      }\n    }\n    let found = Object.entries(this.imports).find(([_, v]) => v === url)?.[0];\n    if (found) {\n      return found;\n    }\n    found = Object.entries(this.resolved).find(([_, v]) => v === url)?.[0];\n    return found;\n  }\n\n  private normalizeModuleUrl(v) {\n    // placeholder\n    // /modules/test.js -> ${baseUrl}/modules/test.js\n    return v;\n  }\n}\n","import { ModuleService } from 'src/modules/boot/ModuleService';\nimport { System } from './types';\n\nexport class BootService {\n  readonly modules = new ModuleService();\n  readonly System: System;\n  readonly baselUrl: string;\n\n  constructor({ System = window['System'], baselUrl = location.origin } = {}) {\n    this.baselUrl = baselUrl;\n    this.System = System;\n  }\n\n  resolvePath(v: string): string {\n    return new URL(v, this.baselUrl).href;\n  }\n}\n"],"names":["async","opts","console","info","bootService","BootService","_bootService","modules","resolver","dev","internals","push","Object","assign","imports","overrides","loadImportOverrides","System","window","originalResolve","constructor","prototype","resolve","id","parentUrl","resolved","original","args","apply","this","debug","localStorage","key","JSON","stringify","v","URL","getBaseUrl","href","ModuleService","dependencies","isInternal","regex","test","tryResolve","err","error","parentName","resolveName","deps","includes","warn","r","normalizeModuleUrl","name","url","e","entries","find","_","local","location","origin","startsWith","m","substr","length","match","found","_Object$entries$find","_Object$entries$find2","baselUrl","resolvePath","parse"],"mappings":"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"}